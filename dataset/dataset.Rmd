---
title: "Dataset Creator"
output:
  html_document:
    df_print: paged
---

```{r}
# Dependencies
library(readr)
library(dplyr)
library(tidyr)
library(lubridate)
library(bizdays)
library(stringr)
```

```{r}
# Create a calendar that lists federal holidays 
bizdays::load_builtin_calendars()
# Using Brazil/ANBIMA because ANBIMA is no longer functional: https://github.com/msperlin/GetTDData/issues/10
# The difference seems to be trivial, as they seem to be the same
cal = bizdays::calendars()[["Brazil/ANBIMA"]]
```

```{r}
# 57 features -> 31 features
JPM_balance_sheet = read_csv("data/BalanceSheetJPM.csv")
JPM_balance_sheet = na.omit(JPM_balance_sheet) 
JPM_balance_sheet = JPM_balance_sheet %>% mutate(across(-1, as.character)) %>%  pivot_longer(
    cols = -1,
    names_to = "Year_Quarter",
    values_to = "value"
  ) %>%
  pivot_wider(
    names_from = 1,  
    values_from = value
  ) %>%
  mutate(Year_Quarter = case_when(
    grepl("SEP", Year_Quarter) ~ paste0("20", sub(".*'(\\d+)", "\\1", Year_Quarter), "-Q3"),
    grepl("JUN", Year_Quarter) ~ paste0("20", sub(".*'(\\d+)", "\\1", Year_Quarter), "-Q2"),
    grepl("MAR", Year_Quarter) ~ paste0("20", sub(".*'(\\d+)", "\\1", Year_Quarter), "-Q1"),
    grepl("DEC", Year_Quarter) ~ paste0("20", sub(".*'(\\d+)", "\\1", Year_Quarter), "-Q4"),
    TRUE ~ Year_Quarter
  ))
JPM_balance_sheet
```
```{r}
# YTD
# 73 features -> 41 features
JPM_cash_flow = read_csv("data/CashFlowJPM.csv") 
JPM_cash_flow = na.omit(JPM_cash_flow)

JPM_cash_flow = JPM_cash_flow  %>% mutate(across(-1, as.character)) %>% pivot_longer(
    cols = -1,
    names_to = "Year_Quarter",
    values_to = "value") %>% pivot_wider(
      names_from = 1,  
      values_from = value,
      values_fn = first
      ) %>%
  mutate(Year_Quarter = case_when(
    grepl("SEP", Year_Quarter) ~ paste0("20", sub(".*'(\\d+)", "\\1", Year_Quarter), "-Q3"),
    grepl("JUN", Year_Quarter) ~ paste0("20", sub(".*'(\\d+)", "\\1", Year_Quarter), "-Q2"),
    grepl("MAR", Year_Quarter) ~ paste0("20", sub(".*'(\\d+)", "\\1", Year_Quarter), "-Q1"),
    grepl("DEC", Year_Quarter) ~ paste0("20", sub(".*'(\\d+)", "\\1", Year_Quarter), "-Q4"),
    TRUE ~ Year_Quarter
  )) %>% mutate(across(!Year_Quarter, ~ {
    . %>%
      str_replace_all("\\.", "") %>%  # Remove thousands separator (period)
      str_replace(",", ".") %>%       # Replace decimal comma with period
      as.numeric()
  }))

JPM_cash_flow = JPM_cash_flow %>% arrange(Year_Quarter) %>% slice(5:n()) %>% mutate(
    Year = as.numeric(substr(Year_Quarter, 1, 4))
  ) %>% group_by(Year) %>% mutate(
  across(
    where(is.numeric),
    ~ if_else(
      row_number() == 1,  # if it's Q1 (first in group)
      .x,                 # keep original YTD value
      .x - lag(.x)        # otherwise, subtract previous quarter
      ))
  ) %>% ungroup() %>% select(!Year)
```
```{r}
# No features lost
FED_funds = read_csv("data/FEDFUNDS.csv") 
FED_funds = na.omit(FED_funds)

FED_funds = FED_funds %>% 
  mutate(Year_Quarter = paste0(year(observation_date), "-Q", quarter(observation_date))) %>% 
  select(Year_Quarter, FEDFUNDS) %>% 
  group_by(Year_Quarter) %>% 
  summarise(FEDFUNDS = mean(FEDFUNDS, na.rm = TRUE)) %>% 
  ungroup()
FED_funds
```
```{r}
# YTD
# 53 features -> 31 features
JPM_income = read_csv("data/IncomeStatementJPM.csv") 
JPM_income = na.omit(JPM_income)

JPM_income = JPM_income %>% mutate(across(-1, as.character)) %>% pivot_longer(
    cols = -1,
    names_to = "Year_Quarter",
    values_to = "value") %>% pivot_wider(
      names_from = 1,  
      values_from = value,
      values_fn = first
      ) %>%
  mutate(Year_Quarter = case_when(
    grepl("SEP", Year_Quarter) ~ paste0("20", sub(".*'(\\d+)", "\\1", Year_Quarter), "-Q3"),
    grepl("JUN", Year_Quarter) ~ paste0("20", sub(".*'(\\d+)", "\\1", Year_Quarter), "-Q2"),
    grepl("MAR", Year_Quarter) ~ paste0("20", sub(".*'(\\d+)", "\\1", Year_Quarter), "-Q1"),
    grepl("DEC", Year_Quarter) ~ paste0("20", sub(".*'(\\d+)", "\\1", Year_Quarter), "-Q4"),
    TRUE ~ Year_Quarter
  ))
JPM_income = JPM_income %>% mutate(across(!Year_Quarter, ~ {
    . %>%
      str_replace_all("\\.", "") %>%  # Remove thousands separator (period)
      str_replace(",", ".") %>%       # Replace decimal comma with period
      as.numeric()
  }))

JPM_income = JPM_income %>% arrange(Year_Quarter) %>% slice(5:n()) %>% mutate(
    Year = as.numeric(substr(Year_Quarter, 1, 4))
  ) %>% group_by(Year) %>% mutate(
  across(
    where(is.numeric),
    ~ if_else(
      row_number() == 1,  # if it's Q1 (first in group)
      .x,                 # keep original YTD value
      .x - lag(.x)        # otherwise, subtract previous quarter
      ))
  ) %>% ungroup() %>% select(!Year)

```



```{r}
JPM = read_csv("data/PriceHistoryJPM.csv")
# Fill in dates to identify quarters
JPM = JPM %>% mutate(Date = offset(as.Date("2025-11-02"), -(0:(n()-1)), cal), Year_Quarter = paste0(year(Date), "-Q", quarter(Date)))
JPM = na.omit(JPM %>% select(Date, Year_Quarter, everything())) # Remove rows with NA values (No value generation for now)

# Merge the datasets
JPM = JPM %>%
  inner_join(JPM_balance_sheet, by = "Year_Quarter") %>%
  inner_join(JPM_cash_flow, by = "Year_Quarter") %>%
  inner_join(FED_funds, by = "Year_Quarter") %>%
  inner_join(JPM_income, by = "Year_Quarter")
```
```{r}
JPM <- JPM %>%
  arrange(Date) %>% 
  mutate(
    # change from yesterday → today
    Percent_change_backward = (Price - lag(Price)) / lag(Price) * 100,

    # change from today → tomorrow
    Percent_change_forward = (lead(Price) - Price) / Price * 100
  )

JPM = JPM %>% select(Date, Year_Quarter, Price, Percent_change_backward, Percent_change_forward, everything()) %>% drop_na()

JPM
```

```{r}
bin_return <- function(x) {
  case_when(
    x < -10                        ~ 1,
    x >= -9    & x <= -8           ~ 2,
    x >= -7    & x <= -6           ~ 3,
    x >= -5    & x <= -4.5         ~ 4,
    x >= -4    & x <= -3.5         ~ 5,
    x >= -3    & x <= -2.5         ~ 6,
    x >= -2.05 & x <= -1.85        ~ 7,
    x >= -1.65 & x <= -1.46        ~ 8,
    x >= -1.26 & x <= -1.06        ~ 9,
    x >= -1.05 & x <= -0.95        ~ 10,
    x >= -0.85 & x <= -0.75        ~ 11,
    x >= -0.65 & x <= -0.55        ~ 12,
    x >= -0.45 & x <= -0.35        ~ 13,
    x >= -0.25 & x <= -0.15        ~ 14,
    x >= -0.05 & x <=  0.05        ~ 15,
    x >=  0.15 & x <=  0.25        ~ 16,
    x >=  0.35 & x <=  0.45        ~ 17,
    x >=  0.55 & x <=  0.65        ~ 18,
    x >=  0.75 & x <=  0.85        ~ 19,
    x >=  0.95 & x <=  1.05        ~ 20,
    x >=  1.06 & x <=  1.26        ~ 21,
    x >=  1.46 & x <=  1.65        ~ 22,
    x >=  1.85 & x <=  2.05        ~ 23,
    x >=  2.55 & x <=  3.05        ~ 24,
    x >=  3.55 & x <=  4.05        ~ 25,
    x >=  4.55 & x <=  5           ~ 26,
    x >=  6    & x <=  7           ~ 27,
    x >=  8    & x <=  9           ~ 28,
    x >  10                        ~ 29,
    TRUE                           ~ NA_integer_
  )
}

bins <- JPM %>%
  transmute(
    Date,
    Percent_change_backward,
    Percent_change_forward,
    Backward_Bin = bin_return(Percent_change_backward),
    Forward_Bin  = bin_return(Percent_change_forward)
  )

labels = bins %>% select(Forward_bin)
```


```{r}
# Remove European commas and convert everything to numeric decimal, remove Date and Quarter features
JPM <- JPM %>%
  select(-Year_Quarter, -Date) %>%
  mutate(across(where(is.character), ~ {
    . %>%
      str_replace_all("\\.", "") %>%  # Remove thousands separator (period)
      str_replace(",", ".") %>%       # Replace decimal comma with period
      as.numeric()
  }))

JPM
```


```{r}
# Final datasets
JPM_final = JPM %>% mutate(index = row_number()) %>% select(index, everything())
JPM_final
Percent_change
```
```{r}
write.csv(Pe, "train.csv", row.names = FALSE)
```


